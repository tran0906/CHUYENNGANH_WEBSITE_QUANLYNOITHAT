@model List<DOANCHUYENNGANH_WEB_QLNOITHAT.Controllers.CartItem>
@{
    ViewData["Title"] = "Giỏ hàng";
}

<!-- Breadcrumb -->
<section class="breadcrumb-section">
    <div class="container">
        <nav class="breadcrumb">
            <a href="/"><i class="fas fa-home"></i> Trang chủ</a>
            <i class="fas fa-chevron-right"></i>
            <span>Giỏ hàng</span>
        </nav>
    </div>
</section>

<div class="container" style="padding: 40px 0;">
    <h1 style="margin-bottom: 30px; color: var(--primary-color);">Giỏ hàng của bạn</h1>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    @if (Model.Any())
    {
        <div style="display: grid; grid-template-columns: 1fr 350px; gap: 30px;">
            <div>
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Sản phẩm</th>
                            <th>Đơn giá</th>
                            <th>Số lượng</th>
                            <th>Thành tiền</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-product="@item.Masp">
                                <td>
                                    <div class="cart-product">
                                        <img src="@(item.Hinhanh ?? "/images/no-image.jpg")" alt="@item.Tensp" />
                                        <div>
                                            <div class="cart-product-name">@item.Tensp</div>
                                            <div style="color: var(--text-light); font-size: 12px;">Mã: @item.Masp</div>
                                        </div>
                                    </div>
                                </td>
                                <td>@item.Giaban.ToString("N0") ₫</td>
                                <td>
                                    <div class="qty-input" style="display: inline-flex;">
                                        <button type="button" onclick="updateQuantity('@item.Masp', @(item.Soluong - 1))">-</button>
                                        <input type="number" value="@item.Soluong" min="1" onchange="updateQuantity('@item.Masp', this.value)" style="width: 50px;" />
                                        <button type="button" onclick="updateQuantity('@item.Masp', @(item.Soluong + 1))">+</button>
                                    </div>
                                </td>
                                <td class="item-total" style="font-weight: 600; color: var(--primary-color);">@item.Thanhtien.ToString("N0") ₫</td>
                                <td>
                                    <button class="cart-remove" onclick="removeItem('@item.Masp')" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <a href="/san-pham" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                    </a>
                    <button class="btn btn-outline" onclick="clearCart()" style="color: var(--danger); border-color: var(--danger);">
                        <i class="fas fa-trash"></i> Xóa tất cả
                    </button>
                </div>
            </div>

            <div class="cart-summary">
                <h3>Tổng đơn hàng</h3>
                <div class="cart-summary-row">
                    <span>Tạm tính:</span>
                    <span id="subtotal">@ViewBag.TotalAmount.ToString("N0") ₫</span>
                </div>
                <div class="cart-summary-row">
                    <span>Phí vận chuyển:</span>
                    <span style="color: var(--success);">Miễn phí</span>
                </div>
                <div class="cart-summary-row total">
                    <span>Tổng cộng:</span>
                    <span id="total">@ViewBag.TotalAmount.ToString("N0") ₫</span>
                </div>
                <a href="/thanh-toan" class="btn btn-primary" style="width: 100%; margin-top: 20px; text-align: center;">
                    <i class="fas fa-credit-card"></i> Tiến hành thanh toán
                </a>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--wood-light); border-radius: 8px;">
                    <p style="font-size: 13px; color: var(--text-light); margin-bottom: 10px;">
                        <i class="fas fa-shield-alt" style="color: var(--primary-color);"></i> Thanh toán an toàn & bảo mật
                    </p>
                    <p style="font-size: 13px; color: var(--text-light);">
                        <i class="fas fa-truck" style="color: var(--primary-color);"></i> Giao hàng miễn phí toàn quốc
                    </p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div style="text-align: center; padding: 80px 20px;">
            <i class="fas fa-shopping-cart" style="font-size: 80px; color: #ddd; margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 15px;">Giỏ hàng trống</h2>
            <p style="color: var(--text-light); margin-bottom: 30px;">Bạn chưa có sản phẩm nào trong giỏ hàng</p>
            <a href="/san-pham" class="btn btn-primary">Mua sắm ngay</a>
        </div>
    }
</div>

<!-- Custom Confirm Modal -->
<div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: modalSlideIn 0.3s ease;">
        <div id="confirmIcon" style="width: 70px; height: 70px; background: #fff3cd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
            <i class="fas fa-question" style="font-size: 30px; color: #856404;"></i>
        </div>
        <h4 id="confirmTitle" style="margin-bottom: 10px; color: #333;">Xác nhận</h4>
        <p id="confirmMessage" style="color: #666; margin-bottom: 25px;">Bạn có chắc chắn muốn thực hiện?</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button id="confirmCancel" style="padding: 12px 30px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                Hủy bỏ
            </button>
            <button id="confirmOk" style="padding: 12px 30px; border: none; background: #dc3545; color: white; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                Xác nhận
            </button>
        </div>
    </div>
</div>

<style>
    @@keyframes modalSlideIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    #confirmCancel:hover { background: #e9ecef; }
    #confirmOk:hover { background: #c82333; }
</style>

@section Scripts {
<script>
    // Custom confirm dialog
    function showConfirm(message, callback) {
        var modal = document.getElementById('confirmModal');
        document.getElementById('confirmMessage').textContent = message;
        modal.style.display = 'flex';
        
        document.getElementById('confirmOk').onclick = function() {
            modal.style.display = 'none';
            callback(true);
        };
        document.getElementById('confirmCancel').onclick = function() {
            modal.style.display = 'none';
            callback(false);
        };
    }

    function updateQuantity(productId, quantity) {
        if (quantity < 1) {
            removeItem(productId);
            return;
        }
        
        fetch('/gio-hang/cap-nhat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'productId=' + productId + '&quantity=' + quantity
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }

    function removeItem(productId) {
        showConfirm('Bạn có chắc chắn muốn xóa sản phẩm này không?', function(confirmed) {
            if (!confirmed) return;
            
            fetch('/gio-hang/xoa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Đã xóa sản phẩm khỏi giỏ hàng!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Có lỗi xảy ra!', 'error');
                }
            });
        });
    }

    function clearCart() {
        showConfirm('Bạn có chắc chắn muốn xóa tất cả sản phẩm không?', function(confirmed) {
            if (!confirmed) return;
            
            fetch('/gio-hang/xoa-tat-ca', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Đã xóa tất cả sản phẩm khỏi giỏ hàng!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Có lỗi xảy ra!', 'error');
                }
            });
        });
    }
</script>
}
