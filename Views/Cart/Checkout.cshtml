@model List<DOANCHUYENNGANH_WEB_QLNOITHAT.Controllers.CartItem>
@{
    ViewData["Title"] = "Thanh toán";
    var customer = ViewBag.Customer as DOANCHUYENNGANH_WEB_QLNOITHAT.Models.KhachHang;
    var totalAmount = (decimal)ViewBag.TotalAmount;
    var requireDeposit = totalAmount >= 2000000; // Đơn >= 2 triệu yêu cầu đặt cọc
    var depositAmount = Math.Round(totalAmount * 0.2m, 0); // Đặt cọc 20%
    var remainingAmount = totalAmount - depositAmount; // Còn lại thanh toán khi nhận hàng
}

<!-- Breadcrumb -->
<section class="breadcrumb-section">
    <div class="container">
        <nav class="breadcrumb">
            <a href="/"><i class="fas fa-home"></i> Trang chủ</a>
            <i class="fas fa-chevron-right"></i>
            <i class="fas fa-chevron-right"></i>
            <a href="/gio-hang">Giỏ hàng</a>
            <i class="fas fa-chevron-right"></i>
            <span>Thanh toán</span>
        </nav>
    </div>
</section>

<div class="container">
    <div class="checkout-section">
        <div class="checkout-form">
            <h3><i class="fas fa-user"></i> Thông tin giao hàng</h3>
            
            <form action="/dat-hang" method="post" id="checkoutForm">
                <div class="form-group">
                    <label>Họ và tên</label>
                    <input type="text" class="form-control" value="@customer?.Hotenkh" readonly />
                </div>
                
                <div class="form-group">
                    <label>Số điện thoại</label>
                    <input type="text" class="form-control" value="@customer?.Sdtkh" readonly />
                </div>
                
                <h4 style="margin-top: 25px; margin-bottom: 15px; color: #8B4513;"><i class="fas fa-map-marker-alt"></i> Địa chỉ giao hàng</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Tỉnh/Thành phố <span style="color: red;">*</span></label>
                        <select class="form-control" id="province" name="province" required>
                            <option value="">-- Chọn Tỉnh/Thành phố --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Quận/Huyện <span style="color: red;">*</span></label>
                        <select class="form-control" id="district" name="district" required disabled>
                            <option value="">-- Chọn Quận/Huyện --</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Phường/Xã <span style="color: red;">*</span></label>
                        <select class="form-control" id="ward" name="ward" required disabled>
                            <option value="">-- Chọn Phường/Xã --</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Số nhà, tên đường <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="street" name="street" placeholder="VD: 123 Nguyễn Văn A" required />
                    </div>
                </div>
                
                <input type="hidden" id="fullAddress" name="diachigiaohang" />
                
                <div class="form-group" style="margin-top: 15px;">
                    <label>Địa chỉ đầy đủ</label>
                    <textarea class="form-control" id="addressPreview" rows="2" readonly style="background: #f8f9fa;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ghi chú đơn hàng (tùy chọn)</label>
                    <textarea class="form-control" name="ghichu" rows="3" placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                </div>

                <h3 style="margin-top: 30px;"><i class="fas fa-credit-card"></i> Phương thức thanh toán</h3>
                
                @if (requireDeposit)
                {
                    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                        <strong style="color: #856404;">Lưu ý:</strong>
                        <span style="color: #856404;">Đơn hàng từ 2.000.000₫ trở lên yêu cầu đặt cọc <strong>20%</strong> (@depositAmount.ToString("N0")₫) qua MoMo.</span>
                    </div>
                }
                
                <div style="margin-top: 20px;">
                    <!-- Thanh toán tiền mặt (COD) - Chỉ hiển thị khi đơn < 2 triệu -->
                    @if (!requireDeposit)
                    {
                        <label style="display: flex; align-items: center; padding: 15px; background: #e8f5e9; border-radius: 8px; cursor: pointer; margin-bottom: 10px; border: 2px solid #4caf50;">
                            <input type="radio" name="paymentMethod" value="cod" checked style="margin-right: 15px;" />
                            <i class="fas fa-money-bill-wave" style="font-size: 32px; color: #4caf50; margin-right: 15px;"></i>
                            <div>
                                <strong style="color: #2e7d32;">Thanh toán khi nhận hàng (COD)</strong>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">Thanh toán bằng tiền mặt khi nhận hàng</p>
                            </div>
                        </label>
                    }
                    
                    <!-- Thanh toán qua MoMo -->
                    <label style="display: flex; align-items: center; padding: 15px; background: #ffe0f0; border-radius: 8px; cursor: pointer; margin-bottom: 10px; border: 2px solid #ae2070;">
                        <input type="radio" name="paymentMethod" value="momo" @(requireDeposit ? "checked" : "") style="margin-right: 15px;" />
                        <img src="https://developers.momo.vn/v3/assets/images/icon-52bd5808cecdb1970e1aeec3c31a3ee1.png" alt="MoMo" style="width: 40px; height: 40px; margin-right: 15px; border-radius: 8px;" />
                        <div>
                            @if (requireDeposit)
                            {
                                <strong style="color: #ae2070;">Đặt cọc 20% qua MoMo</strong>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">Thanh toán @depositAmount.ToString("N0")₫ bằng thẻ ATM nội địa</p>
                            }
                            else
                            {
                                <strong style="color: #ae2070;">Thanh toán qua MoMo</strong>
                                <p style="font-size: 13px; color: var(--text-light); margin: 0;">Thanh toán bằng thẻ ATM nội địa (Vietcombank, BIDV, Techcombank...)</p>
                            }
                        </div>
                    </label>
                    
                    <!-- Hướng dẫn test MoMo (chỉ hiển thị khi chọn MoMo) -->
                    <div id="momoTestInfo" style="background: #e8f4fd; border: 1px solid #bee5eb; padding: 12px; border-radius: 8px; margin-top: 10px; display: none;">
                        <p style="margin: 0 0 8px 0; font-weight: 600; color: #0c5460;"><i class="fas fa-info-circle"></i> Thông tin thẻ test (Demo):</p>
                        <div style="font-size: 13px; color: #0c5460;">
                            <p style="margin: 3px 0;">• Số thẻ: <strong>9704 0000 0000 0018</strong></p>
                            <p style="margin: 3px 0;">• Tên chủ thẻ: <strong>NGUYEN VAN A</strong></p>
                            <p style="margin: 3px 0;">• Ngày phát hành: <strong>03/07</strong></p>
                            <p style="margin: 3px 0;">• OTP: <strong>000000</strong></p>
                        </div>
                    </div>
                </div>

                @if (TempData["Error"] != null)
                {
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; margin-top: 20px;">
                        <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
                    </div>
                }

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px; padding: 15px; cursor: pointer; background: #8B4513; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600;">
                    <i class="fas fa-check"></i> Đặt hàng
                </button>
            </form>
        </div>

        <div class="order-summary">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">Đơn hàng của bạn</h3>
            
            @foreach (var item in Model)
            {
                <div class="order-item">
                    <img src="@(item.Hinhanh ?? "/images/no-image.jpg")" alt="@item.Tensp" />
                    <div class="order-item-info">
                        <div class="order-item-name">@item.Tensp</div>
                        <div class="order-item-qty">Số lượng: @item.Soluong</div>
                    </div>
                    <div class="order-item-price">@item.Thanhtien.ToString("N0") ₫</div>
                </div>
            }
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--gray-medium);">
                <div class="cart-summary-row">
                    <span>Tạm tính:</span>
                    <span>@totalAmount.ToString("N0") ₫</span>
                </div>
                <div class="cart-summary-row">
                    <span>Phí vận chuyển:</span>
                    <span style="color: var(--success);">Miễn phí</span>
                </div>
                @if (requireDeposit)
                {
                    <div class="cart-summary-row" style="color: #ae2070;">
                        <span><i class="fas fa-wallet"></i> Đặt cọc 20%:</span>
                        <span style="font-weight: 600;">@depositAmount.ToString("N0") ₫</span>
                    </div>
                    <div class="cart-summary-row" style="color: #28a745;">
                        <span><i class="fas fa-truck"></i> Còn lại (COD):</span>
                        <span style="font-weight: 600;">@remainingAmount.ToString("N0") ₫</span>
                    </div>
                }
                <div class="cart-summary-row total" style="font-size: 20px; margin-top: 15px;">
                    <span>Tổng cộng:</span>
                    <span style="color: var(--primary-color);">@totalAmount.ToString("N0") ₫</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/validation.js"></script>
<script>
    // ========== API Địa chỉ Việt Nam ==========
    const API_URL = 'https://provinces.open-api.vn/api';
    
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const wardSelect = document.getElementById('ward');
    const streetInput = document.getElementById('street');
    const addressPreview = document.getElementById('addressPreview');
    const fullAddressInput = document.getElementById('fullAddress');

    // Load danh sách Tỉnh/Thành phố
    async function loadProvinces() {
        try {
            const response = await fetch(`${API_URL}/p/`);
            const provinces = await response.json();
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.code;
                option.textContent = province.name;
                option.dataset.name = province.name;
                provinceSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Lỗi load tỉnh/thành:', error);
        }
    }

    // Load danh sách Quận/Huyện theo Tỉnh
    async function loadDistricts(provinceCode) {
        districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        districtSelect.disabled = true;
        wardSelect.disabled = true;
        
        if (!provinceCode) return;
        
        try {
            const response = await fetch(`${API_URL}/p/${provinceCode}?depth=2`);
            const data = await response.json();
            data.districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.code;
                option.textContent = district.name;
                option.dataset.name = district.name;
                districtSelect.appendChild(option);
            });
            districtSelect.disabled = false;
        } catch (error) {
            console.error('Lỗi load quận/huyện:', error);
        }
    }

    // Load danh sách Phường/Xã theo Quận/Huyện
    async function loadWards(districtCode) {
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        wardSelect.disabled = true;
        
        if (!districtCode) return;
        
        try {
            const response = await fetch(`${API_URL}/d/${districtCode}?depth=2`);
            const data = await response.json();
            data.wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward.code;
                option.textContent = ward.name;
                option.dataset.name = ward.name;
                wardSelect.appendChild(option);
            });
            wardSelect.disabled = false;
        } catch (error) {
            console.error('Lỗi load phường/xã:', error);
        }
    }

    // Cập nhật địa chỉ đầy đủ
    function updateFullAddress() {
        const provinceName = provinceSelect.options[provinceSelect.selectedIndex]?.dataset?.name || '';
        const districtName = districtSelect.options[districtSelect.selectedIndex]?.dataset?.name || '';
        const wardName = wardSelect.options[wardSelect.selectedIndex]?.dataset?.name || '';
        const street = streetInput.value.trim();
        
        const parts = [street, wardName, districtName, provinceName].filter(p => p);
        const fullAddress = parts.join(', ');
        
        addressPreview.value = fullAddress;
        fullAddressInput.value = fullAddress;
    }

    // Event listeners
    provinceSelect.addEventListener('change', function() {
        loadDistricts(this.value);
        updateFullAddress();
        Validator.clearError(this);
    });

    districtSelect.addEventListener('change', function() {
        loadWards(this.value);
        updateFullAddress();
        Validator.clearError(this);
    });

    wardSelect.addEventListener('change', function() {
        updateFullAddress();
        Validator.clearError(this);
    });
    
    streetInput.addEventListener('input', function() {
        updateFullAddress();
        Validator.clearError(this);
    });
    
    // Validate số nhà khi blur
    streetInput.addEventListener('blur', function() {
        if (Validator.isEmpty(this.value)) {
            Validator.showError(this, 'Vui lòng nhập số nhà, tên đường');
        } else if (this.value.length < 5) {
            Validator.showError(this, 'Địa chỉ quá ngắn (tối thiểu 5 ký tự)');
        } else {
            Validator.showSuccess(this);
        }
    });

    // Validate form trước khi submit
    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        let isValid = true;
        let errorMessages = [];
        
        // Validate Tỉnh/Thành phố
        if (!provinceSelect.value) {
            Validator.showError(provinceSelect, 'Vui lòng chọn Tỉnh/Thành phố');
            errorMessages.push('Tỉnh/Thành phố');
            isValid = false;
        }
        
        // Validate Quận/Huyện
        if (!districtSelect.value) {
            Validator.showError(districtSelect, 'Vui lòng chọn Quận/Huyện');
            errorMessages.push('Quận/Huyện');
            isValid = false;
        }
        
        // Validate Phường/Xã
        if (!wardSelect.value) {
            Validator.showError(wardSelect, 'Vui lòng chọn Phường/Xã');
            errorMessages.push('Phường/Xã');
            isValid = false;
        }
        
        // Validate Số nhà, tên đường
        if (Validator.isEmpty(streetInput.value)) {
            Validator.showError(streetInput, 'Vui lòng nhập số nhà, tên đường');
            errorMessages.push('Số nhà, tên đường');
            isValid = false;
        } else if (streetInput.value.trim().length < 5) {
            Validator.showError(streetInput, 'Địa chỉ quá ngắn (tối thiểu 5 ký tự)');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Scroll đến lỗi đầu tiên
            const firstError = this.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            return false;
        }
        
        updateFullAddress();
    });

    // Load tỉnh/thành khi trang load
    loadProvinces();
    
    // Hiển thị/ẩn thông tin test MoMo khi chọn phương thức thanh toán
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const momoTestInfo = document.getElementById('momoTestInfo');
            if (momoTestInfo) {
                momoTestInfo.style.display = this.value === 'momo' ? 'block' : 'none';
            }
        });
    });
    
    // Kiểm tra ban đầu
    const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
    if (selectedPayment && selectedPayment.value === 'momo') {
        const momoTestInfo = document.getElementById('momoTestInfo');
        if (momoTestInfo) momoTestInfo.style.display = 'block';
    }
</script>
