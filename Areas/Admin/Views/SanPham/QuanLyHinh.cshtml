@{
    ViewData["Title"] = "Qu·∫£n l√Ω h√¨nh ·∫£nh s·∫£n ph·∫©m";
    var images = ViewBag.Images as List<string> ?? new List<string>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-images"></i> Qu·∫£n l√Ω h√¨nh ·∫£nh s·∫£n ph·∫©m</h4>
    <a asp-action="Index" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Quay l·∫°i danh s√°ch SP</a>
</div>

<!-- H∆∞·ªõng d·∫´n n·ªïi b·∫≠t -->
<div class="alert alert-info mb-4">
    <h5 class="alert-heading"><i class="bi bi-info-circle"></i> H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h5>
    <ol class="mb-0">
        <li><strong>Upload h√¨nh</strong> ·ªü b√™n tr√°i (c√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c)</li>
        <li>Sau khi upload, h√¨nh s·∫Ω hi·ªÉn th·ªã trong <strong>Th∆∞ vi·ªán</strong> b√™n ph·∫£i</li>
        <li>Click n√∫t <span class="badge bg-primary"><i class="bi bi-clipboard"></i></span> ƒë·ªÉ <strong>copy ƒë∆∞·ªùng d·∫´n</strong></li>
        <li>D√°n ƒë∆∞·ªùng d·∫´n v√†o √¥ <strong>"H√¨nh ·∫£nh"</strong> khi th√™m/s·ª≠a s·∫£n ph·∫©m</li>
    </ol>
    <hr>
    <p class="mb-0"><i class="bi bi-folder"></i> <strong>Th∆∞ m·ª•c l∆∞u tr·ªØ:</strong> <code>wwwroot/images/products/</code></p>
</div>

<div class="row">
    <!-- Upload Form -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header"><i class="bi bi-cloud-upload"></i> Upload h√¨nh ·∫£nh m·ªõi</div>
            <div class="card-body">
                <form asp-action="UploadNhieuHinh" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ch·ªçn file h√¨nh ·∫£nh</label>
                        <input type="file" name="files" class="form-control" multiple accept="image/*" id="fileInput" />
                        <small class="text-muted">H·ªó tr·ª£: jpg, png, gif, webp. Ch·ªçn ƒë∆∞·ª£c nhi·ªÅu file.</small>
                    </div>
                    <div id="previewContainer" class="mb-3"></div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i> Upload t·∫•t c·∫£
                    </button>
                </form>
                
                <hr />
                <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center" 
                     style="border-color: #6366f1 !important; cursor: pointer; background: #f8fafc;">
                    <i class="bi bi-cloud-arrow-up" style="font-size: 40px; color: #6366f1;"></i>
                    <p class="mb-0 mt-2 text-muted">Ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-success text-white"><i class="bi bi-check-circle"></i> Th√¥ng tin</div>
            <div class="card-body">
                <p class="mb-2"><i class="bi bi-image"></i> <strong>T·ªïng s·ªë h√¨nh:</strong> <span class="badge bg-primary">@images.Count</span></p>
                <p class="mb-0 text-muted small">
                    <i class="bi bi-lightbulb"></i> <strong>M·∫πo:</strong> Sau khi upload, click v√†o h√¨nh ƒë·ªÉ xem ƒë∆∞·ªùng d·∫´n ƒë·∫ßy ƒë·ªß
                </p>
            </div>
        </div>
    </div>
    
    <!-- Image Gallery -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-grid"></i> Th∆∞ vi·ªán h√¨nh ·∫£nh (<strong>@images.Count</strong> h√¨nh)</span>
                <input type="text" id="searchImage" class="form-control form-control-sm" style="width: 200px;" placeholder="üîç T√¨m ki·∫øm..." />
            </div>
            <div class="card-body">
                @if (images.Any())
                {
                    <div class="row g-3" id="imageGallery">
                        @foreach (var img in images)
                        {
                            var fileName = System.IO.Path.GetFileName(img);
                            <div class="col-6 col-md-4 col-lg-3 image-item" data-name="@fileName.ToLower()">
                                <div class="card h-100 image-card">
                                    <img src="@img" class="card-img-top" style="height: 100px; object-fit: cover; cursor: pointer;" 
                                         onclick="showImageModal('@img', '@fileName')" title="Click ƒë·ªÉ xem chi ti·∫øt" />
                                    <div class="card-body p-2">
                                        <p class="small mb-1 text-truncate fw-bold" title="@fileName">@fileName</p>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="text" class="form-control form-control-sm" value="@img" readonly style="font-size: 10px;" />
                                            <button class="btn btn-primary btn-sm" type="button" onclick="copyPath('@img')" title="Copy ƒë∆∞·ªùng d·∫´n">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                        <form asp-action="XoaHinh" method="post" style="display:inline;" 
                                              onsubmit="return confirm('X√≥a h√¨nh @fileName?');">
                                            <input type="hidden" name="imagePath" value="@img" />
                                            <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                                <i class="bi bi-trash"></i> X√≥a
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-image" style="font-size: 64px; color: #ddd;"></i>
                        <p class="text-muted mt-3">Ch∆∞a c√≥ h√¨nh ·∫£nh n√†o. H√£y upload h√¨nh ·ªü b√™n tr√°i!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>


<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-image"></i> <span id="modalFileName">H√¨nh ·∫£nh</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="modalImage" src="" class="img-fluid rounded shadow" style="max-height: 400px;" />
            </div>
            <div class="modal-footer">
                <div class="w-100">
                    <label class="form-label fw-bold"><i class="bi bi-link-45deg"></i> ƒê∆∞·ªùng d·∫´n h√¨nh ·∫£nh (copy ƒë·ªÉ d√πng):</label>
                    <div class="input-group">
                        <input type="text" id="modalPath" class="form-control bg-light" readonly />
                        <button class="btn btn-success" onclick="copyPath(document.getElementById('modalPath').value)">
                            <i class="bi bi-clipboard-check"></i> Copy ƒë∆∞·ªùng d·∫´n
                        </button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        <i class="bi bi-info-circle"></i> D√°n ƒë∆∞·ªùng d·∫´n n√†y v√†o √¥ "H√¨nh ·∫£nh" khi th√™m/s·ª≠a s·∫£n ph·∫©m
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .image-card { transition: all 0.2s; }
    .image-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
    .border-dashed { border-style: dashed !important; }
    #dropZone.dragover { background: #e0e7ff !important; border-color: #4f46e5 !important; }
</style>

@section Scripts {
<script>
    // Preview files before upload
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const container = document.getElementById('previewContainer');
        container.innerHTML = '';
        const files = e.target.files;
        
        if (files.length > 0) {
            const row = document.createElement('div');
            row.className = 'row g-2';
            
            Array.from(files).slice(0, 6).forEach((file) => {
                if (file.type.startsWith('image/')) {
                    const col = document.createElement('div');
                    col.className = 'col-4';
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        col.innerHTML = `<img src="${e.target.result}" class="img-thumbnail" style="height:50px; width:100%; object-fit:cover;" />`;
                    };
                    reader.readAsDataURL(file);
                    row.appendChild(col);
                }
            });
            
            container.appendChild(row);
            const moreText = files.length > 6 ? ` (+${files.length - 6} file kh√°c)` : '';
            container.innerHTML += `<div class="alert alert-success py-2 mt-2 mb-0"><i class="bi bi-check-circle"></i> ƒê√£ ch·ªçn <strong>${files.length}</strong> file${moreText}</div>`;
        }
    });
    
    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
    });
    
    // Search images
    document.getElementById('searchImage').addEventListener('input', function() {
        const search = this.value.toLowerCase();
        document.querySelectorAll('.image-item').forEach(item => {
            item.style.display = item.dataset.name.includes(search) ? '' : 'none';
        });
    });
    
    // Show image modal
    function showImageModal(src, name) {
        document.getElementById('modalImage').src = src;
        document.getElementById('modalFileName').textContent = name;
        document.getElementById('modalPath').value = src;
        new bootstrap.Modal(document.getElementById('imageModal')).show();
    }
    
    // Copy path to clipboard
    function copyPath(path) {
        navigator.clipboard.writeText(path).then(() => {
            showToast('success', 'ƒê√£ copy!', 'ƒê∆∞·ªùng d·∫´n: ' + path);
        }).catch(() => {
            // Fallback for older browsers
            const input = document.createElement('input');
            input.value = path;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            showToast('success', 'ƒê√£ copy!', 'ƒê∆∞·ªùng d·∫´n: ' + path);
        });
    }
</script>
}
