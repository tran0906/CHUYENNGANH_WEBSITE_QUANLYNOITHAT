@using System.Data
@{
    ViewData["Title"] = "Thống kê Doanh thu";
    var data = ViewBag.DoanhThuData as DataTable;
}

<h2 class="mb-4">Thống kê Doanh thu</h2>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Từ ngày</label>
                <input type="date" name="tuNgay" class="form-control" value="@ViewBag.TuNgay" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Đến ngày</label>
                <input type="date" name="denNgay" class="form-control" value="@ViewBag.DenNgay" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Nhóm theo</label>
                <select name="groupBy" class="form-select">
                    <option value="day" selected="@(ViewBag.GroupBy == "day")">Ngày</option>
                    <option value="month" selected="@(ViewBag.GroupBy == "month")">Tháng</option>
                    <option value="year" selected="@(ViewBag.GroupBy == "year")">Năm</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Lọc
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>@(((decimal)ViewBag.TongDoanhThu).ToString("N0")) đ</h3>
                <p class="mb-0">Tổng doanh thu</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>@(data?.Rows.Count ?? 0)</h3>
                <p class="mb-0">Số kỳ có doanh thu</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>@(data?.AsEnumerable().Sum(r => r.Field<int>("SoDonHang")) ?? 0)</h3>
                <p class="mb-0">Tổng đơn hàng</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between">
        <strong>Chi tiết doanh thu</strong>
        <a asp-action="Index" class="btn btn-sm btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Thời gian</th>
                        <th class="text-end">Số đơn hàng</th>
                        <th class="text-end">Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    @if (data != null && data.Rows.Count > 0)
                    {
                        @foreach (DataRow row in data.Rows)
                        {
                            <tr>
                                <td>@row["ThoiGian"]</td>
                                <td class="text-end">@row["SoDonHang"]</td>
                                <td class="text-end text-success fw-bold">@(Convert.ToDecimal(row["DoanhThu"]).ToString("N0")) đ</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="3" class="text-center text-muted">Không có dữ liệu</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
