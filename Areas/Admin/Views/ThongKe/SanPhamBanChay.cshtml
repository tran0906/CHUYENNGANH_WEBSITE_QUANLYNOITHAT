@using System.Data
@model DataTable
@{
    ViewData["Title"] = "Sản phẩm bán chạy";
}

@functions {
    string GetFirstImage(string? hinhanh)
    {
        if (string.IsNullOrEmpty(hinhanh)) return "/images/no-image.jpg";
        var images = hinhanh.Split(';', StringSplitOptions.RemoveEmptyEntries);
        foreach (var img in images)
        {
            var trimmed = img.Trim();
            if (!string.IsNullOrEmpty(trimmed) && (trimmed.StartsWith("/") || trimmed.StartsWith("http")))
                return trimmed;
        }
        return "/images/no-image.jpg";
    }
}

<h2 class="mb-4">Sản phẩm bán chạy</h2>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Từ ngày</label>
                <input type="date" name="tuNgay" class="form-control" value="@ViewBag.TuNgay" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Đến ngày</label>
                <input type="date" name="denNgay" class="form-control" value="@ViewBag.DenNgay" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Số lượng hiển thị</label>
                <select name="top" class="form-select">
                    <option value="5" selected="@(ViewBag.Top == 5)">Top 5</option>
                    <option value="10" selected="@(ViewBag.Top == 10)">Top 10</option>
                    <option value="20" selected="@(ViewBag.Top == 20)">Top 20</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Lọc
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between">
        <strong>Top @ViewBag.Top sản phẩm bán chạy</strong>
        <a asp-action="Index" class="btn btn-sm btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Hình ảnh</th>
                        <th>Mã SP</th>
                        <th>Tên sản phẩm</th>
                        <th class="text-end">Số lượng bán</th>
                        <th class="text-end">Doanh thu</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Rows.Count > 0)
                    {
                        int stt = 1;
                        @foreach (DataRow row in Model.Rows)
                        {
                            // Lấy giá trị - tên cột chuẩn từ query
                            var maSp = row["MASP"]?.ToString() ?? "N/A";
                            var tenSp = row["TENSP"]?.ToString() ?? "N/A";
                            var hinhAnh = row["HINHANH"]?.ToString();
                            var soLuong = row["TongSoLuong"] != DBNull.Value ? Convert.ToInt32(row["TongSoLuong"]) : 0;
                            var doanhThu = row["TongDoanhThu"] != DBNull.Value ? Convert.ToDecimal(row["TongDoanhThu"]) : 0;
                            <tr>
                                <td>
                                    @if (stt <= 3)
                                    {
                                        <span class="badge @(stt == 1 ? "bg-warning" : stt == 2 ? "bg-secondary" : "bg-danger")">
                                            <i class="bi bi-trophy"></i> @stt
                                        </span>
                                    }
                                    else
                                    {
                                        @stt
                                    }
                                </td>
                                <td>
                                    <img src="@GetFirstImage(hinhAnh)" alt="@tenSp" style="width: 50px; height: 50px; object-fit: cover;" class="rounded" />
                                </td>
                                <td>@maSp</td>
                                <td>@tenSp</td>
                                <td class="text-end fw-bold">@soLuong</td>
                                <td class="text-end text-success fw-bold">@doanhThu.ToString("N0") đ</td>
                            </tr>
                            stt++;
                        }
                    }
                    else
                    {
                        <tr><td colspan="6" class="text-center text-muted">Không có dữ liệu</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
