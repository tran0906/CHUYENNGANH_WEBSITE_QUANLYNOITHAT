@model DonHang
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var tongTien = Model.CtDonhangs?.Sum(x => x.Thanhtien ?? 0) ?? 0;
    
    var vaiTro = Context.Session.GetString("AdminVaiTro");
    var isAdmin = vaiTro == "Admin" || vaiTro == "QuanLy" || vaiTro == "Quản trị hệ thống";
    
    var badgeClass = Model.Trangthai switch
    {
        "Đã hủy" => "bg-danger",
        "Hoàn thành" or "Đã giao" => "bg-success",
        _ => "bg-secondary"
    };
}

<style>
    .card-header-main { background: #8B4513; color: white; }
    .timeline { display: flex; justify-content: space-between; margin: 15px 0; padding: 0; list-style: none; position: relative; }
    .timeline::before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: #ddd; }
    .timeline li { flex: 1; text-align: center; position: relative; z-index: 1; }
    .timeline .icon { width: 30px; height: 30px; border-radius: 50%; background: #ddd; color: #666; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 5px; font-size: 12px; }
    .timeline .icon.done { background: #8B4513; color: white; }
    .timeline .icon.current { background: #A0522D; color: white; }
    .timeline .icon.cancelled { background: #dc3545; color: white; }
    .timeline .label { font-size: 11px; color: #666; }
    .timeline .label.done, .timeline .label.current { color: #8B4513; font-weight: 600; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-receipt"></i> Chi tiết đơn hàng #@Model.Madonhang</h2>
    <span class="badge @badgeClass fs-6 px-3 py-2">@Model.Trangthai</span>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Timeline -->
<div class="card mb-3">
    <div class="card-body py-2">
        @{
            var steps = new[] { "Chờ xác nhận", "Đã xác nhận", "Đang xử lý", "Đang giao", "Hoàn thành" };
            var currentIndex = Model.Trangthai == "Chờ thanh toán" ? 0 : Array.IndexOf(steps, Model.Trangthai);
            if (Model.Trangthai == "Đã giao") currentIndex = 4;
            var isCancelled = Model.Trangthai == "Đã hủy";
        }
        <ul class="timeline">
            @for (int i = 0; i < steps.Length; i++)
            {
                var isDone = !isCancelled && i < currentIndex;
                var isCurrent = !isCancelled && i == currentIndex;
                var iconClass = isCancelled ? "" : (isDone ? "done" : (isCurrent ? "current" : ""));
                var icons = new[] { "bi-clock", "bi-check", "bi-box", "bi-truck", "bi-check-circle" };
                <li>
                    <div class="icon @iconClass @(isCancelled && i == 0 ? "cancelled" : "")">
                        <i class="bi @(isCancelled && i == 0 ? "bi-x" : icons[i])"></i>
                    </div>
                    <div class="label @iconClass">@steps[i]</div>
                </li>
            }
        </ul>
    </div>
</div>

<div class="row">
    <!-- Thông tin đơn hàng -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header card-header-main">
                <i class="bi bi-info-circle"></i> Thông tin đơn hàng
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr><td class="text-muted">Mã ĐH:</td><td><strong>@Model.Madonhang</strong></td></tr>
                    <tr><td class="text-muted">Ngày đặt:</td><td>@Model.Ngaydat.ToString("dd/MM/yyyy HH:mm")</td></tr>
                    <tr><td class="text-muted">Trạng thái:</td><td><span class="badge @badgeClass">@Model.Trangthai</span></td></tr>
                    @if (!string.IsNullOrEmpty(Model.Ghichu))
                    {
                        <tr><td class="text-muted">Ghi chú:</td><td><small>@Model.Ghichu</small></td></tr>
                    }
                </table>
            </div>
        </div>
    </div>
    
    <!-- Thông tin khách hàng -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header card-header-main">
                <i class="bi bi-person"></i> Khách hàng
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless mb-0">
                    <tr><td class="text-muted">Mã KH:</td><td>@Model.Makh</td></tr>
                    <tr><td class="text-muted">Họ tên:</td><td><strong>@Model.MakhNavigation?.Hotenkh</strong></td></tr>
                    <tr><td class="text-muted">SĐT:</td><td>@Model.MakhNavigation?.Sdtkh</td></tr>
                    <tr><td class="text-muted">Địa chỉ:</td><td>@Model.MakhNavigation?.Diachikh</td></tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Người xử lý -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header card-header-main">
                <i class="bi bi-person-check"></i> Người xử lý
            </div>
            <div class="card-body">
                @if (ViewBag.NguoiDuyet != null)
                {
                    var nguoiDuyet = ViewBag.NguoiDuyet as DOANCHUYENNGANH_WEB_QLNOITHAT.Models.User;
                    <table class="table table-sm table-borderless mb-0">
                        <tr><td class="text-muted">Mã NV:</td><td>@nguoiDuyet?.UserId</td></tr>
                        <tr><td class="text-muted">Họ tên:</td><td><strong>@nguoiDuyet?.HoTen</strong></td></tr>
                        <tr><td class="text-muted">Chức vụ:</td><td>@nguoiDuyet?.VaiTro</td></tr>
                    </table>
                }
                else
                {
                    <p class="text-muted text-center mb-0 py-3">Chưa có người xử lý</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Chi tiết sản phẩm -->
<div class="card mb-3">
    <div class="card-header card-header-main">
        <i class="bi bi-cart3"></i> Chi tiết sản phẩm
    </div>
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Sản phẩm</th>
                    <th class="text-center">SL</th>
                    <th class="text-end">Đơn giá</th>
                    <th class="text-end">Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @{ var stt = 0; }
                @foreach (var ct in Model.CtDonhangs ?? new List<CtDonhang>())
                {
                    stt++;
                    <tr>
                        <td>@stt</td>
                        <td>@(ct.MaspNavigation?.Tensp ?? "N/A")<br><small class="text-muted">@ct.Masp</small></td>
                        <td class="text-center">@ct.Soluong</td>
                        <td class="text-end">@ct.Dongia?.ToString("N0") đ</td>
                        <td class="text-end"><strong>@ct.Thanhtien?.ToString("N0") đ</strong></td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <th colspan="4" class="text-end">Tổng cộng:</th>
                    <th class="text-end text-danger fs-5">@tongTien.ToString("N0") đ</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Xử lý đơn hàng -->
<div class="card mb-3">
    <div class="card-header card-header-main">
        <i class="bi bi-gear"></i> Xử lý đơn hàng
    </div>
    <div class="card-body">
        @if (Model.Trangthai == "Chờ thanh toán")
        {
            var ghiChuTT = Model.Ghichu ?? "";
            var isDatCocTT = ghiChuTT.Contains("ĐẶT CỌC");
            decimal tienDatCocTT = isDatCocTT ? Math.Round(tongTien * 0.3m, 0) : tongTien;
            
            <p class="mb-2"><strong>Đơn hàng chuyển khoản</strong> - Chờ khách thanh toán</p>
            <p class="mb-3">Số tiền cần nhận: <strong class="text-danger">@tienDatCocTT.ToString("N0") đ</strong></p>
            <form asp-action="XacNhanThanhToan" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <button type="submit" class="btn btn-success"><i class="bi bi-check"></i> Xác nhận đã nhận tiền</button>
            </form>
        }
        else if (Model.Trangthai == "Chờ xác nhận")
        {
            <p class="mb-3">Xác nhận đơn hàng từ khách hàng</p>
            <form asp-action="UpdateTrangThai" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <input type="hidden" name="trangThai" value="Đã xác nhận" />
                <button type="submit" class="btn btn-primary"><i class="bi bi-check"></i> Xác nhận đơn hàng</button>
            </form>
        }
        else if (Model.Trangthai == "Đã xác nhận")
        {
            <p class="mb-3">Xuất kho chuẩn bị hàng</p>
            <form asp-action="XuatKho" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <button type="submit" class="btn btn-primary"><i class="bi bi-box"></i> Xuất kho</button>
            </form>
        }
        else if (Model.Trangthai == "Đang xử lý")
        {
            <p class="mb-2">Điều phối giao hàng</p>
            <a asp-area="Admin" asp-controller="PhieuXuatKho" asp-action="PrintByDonHang" asp-route-maDonHang="@Model.Madonhang" 
               class="btn btn-outline-secondary btn-sm mb-3" target="_blank">
                <i class="bi bi-printer"></i> In phiếu xuất kho
            </a>
            <form asp-action="DieuPhoiGiaoHang" method="post" class="row g-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <div class="col-md-6">
                    <select name="donViVanChuyen" class="form-select" required>
                        <option value="">-- Chọn đơn vị vận chuyển --</option>
                        <option value="Giao hàng nhanh (GHN)">GHN</option>
                        <option value="Giao hàng tiết kiệm (GHTK)">GHTK</option>
                        <option value="J&T Express">J&T Express</option>
                        <option value="Viettel Post">Viettel Post</option>
                        <option value="Giao hàng nội bộ">Nội bộ</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-truck"></i> Giao vận chuyển</button>
                </div>
            </form>
        }
        else if (Model.Trangthai == "Đang giao")
        {
            <p class="mb-3">Xác nhận đã giao hàng thành công</p>
            <a asp-area="Admin" asp-controller="PhieuXuatKho" asp-action="PrintByDonHang" asp-route-maDonHang="@Model.Madonhang" 
               class="btn btn-outline-secondary btn-sm mb-3" target="_blank">
                <i class="bi bi-printer"></i> In phiếu xuất kho
            </a>
            <form asp-action="UpdateTrangThai" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <input type="hidden" name="trangThai" value="Đã giao" />
                <button type="submit" class="btn btn-success"><i class="bi bi-check"></i> Xác nhận đã giao</button>
            </form>
        }
        else if (Model.Trangthai == "Đã giao")
        {
            var ghiChu = Model.Ghichu ?? "";
            var isDatCoc = ghiChu.Contains("ĐẶT CỌC");
            var isMoMoPaid = ghiChu.Contains("[MOMO ĐÃ THANH TOÁN") || ghiChu.Contains("[MOMO IPN");
            var isMoMoOrder = ghiChu.Contains("[MOMO:") || ghiChu.Contains("[MOMO ");
            var isChuyenKhoan100 = ghiChu.Contains("[CHUYỂN KHOẢN]") && !isDatCoc;
            var isFullyPaid = (isMoMoPaid && !isDatCoc) || isChuyenKhoan100 || (isMoMoOrder && !isDatCoc);
            
            decimal tienConLai = tongTien;
            if (isDatCoc)
            {
                var match = System.Text.RegularExpressions.Regex.Match(ghiChu, @"CÒN LẠI:\s*([\d,\.]+)");
                if (match.Success) decimal.TryParse(match.Groups[1].Value.Replace(",", "").Replace(".", ""), out tienConLai);
                else tienConLai = Math.Round(tongTien * 0.7m, 0);
            }
            
            <a asp-area="Admin" asp-controller="PhieuXuatKho" asp-action="PrintByDonHang" asp-route-maDonHang="@Model.Madonhang" 
               class="btn btn-outline-secondary btn-sm mb-3" target="_blank">
                <i class="bi bi-printer"></i> In phiếu xuất kho
            </a>
            
            @if (isFullyPaid)
            {
                <p class="mb-3">Đơn hàng đã thanh toán đầy đủ</p>
            }
            else
            {
                <p class="mb-2">Thu tiền COD: <strong class="text-danger">@tienConLai.ToString("N0") đ</strong></p>
            }
            <form asp-action="XacNhanThanhToan" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Madonhang" />
                <button type="submit" class="btn btn-success"><i class="bi bi-check"></i> Hoàn thành đơn hàng</button>
            </form>
        }
        else if (Model.Trangthai == "Hoàn thành")
        {
            <p class="text-success mb-3"><i class="bi bi-check-circle"></i> Đơn hàng đã hoàn thành</p>
            <a asp-area="Admin" asp-controller="PhieuXuatKho" asp-action="PrintByDonHang" asp-route-maDonHang="@Model.Madonhang" 
               class="btn btn-outline-secondary btn-sm" target="_blank">
                <i class="bi bi-printer"></i> In phiếu xuất kho
            </a>
        }
        else if (Model.Trangthai == "Đã hủy")
        {
            <p class="text-danger mb-0"><i class="bi bi-x-circle"></i> Đơn hàng đã bị hủy</p>
        }
    </div>
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Quay lại</a>
</div>
